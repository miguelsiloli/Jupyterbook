
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>01: Price Regression with LightGBM &#8212; Visualization Curriculum</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=384b581d" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css?v=be8a1c11" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/tabs.css?v=a5c4661c" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=36754332"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '03_Vinted_Data_Science/01_price_prediction';</script>
    <script src="../_static/js/mermaid.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="02: Clustering of product catalogs with Agglomerative Clustering and t-SNE" href="02_catalog_clustering.html" />
    <link rel="prev" title="03: Pipeline Design" href="../01_Vinted_Data_Engineering/02_pipeline_design.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="../intro.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../_static/logo.png" class="logo__image only-light" alt="Visualization Curriculum - Home"/>
    <script>document.write(`<img src="../_static/logo.png" class="logo__image only-dark" alt="Visualization Curriculum - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../intro.html">
                    Introduction
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Vinted Data Engineering</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../01_Vinted_Data_Engineering/00_intro.html">01: Overview of the Vinted Project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../01_Vinted_Data_Engineering/01_vinted_api.html">02: Vinted API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../01_Vinted_Data_Engineering/02_pipeline_design.html">03: Pipeline Design</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Vinted Data Science</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="02_catalog_clustering.html"><span class="xref myst">02: Clustering of product catalogs with Agglomerative Clustering and t-SNE</span></a></li>
<li class="toctree-l1"><a class="reference internal" href="05_user_clustering.html"><span class="xref myst">05: Clustering users using KMeans and t-SNE</span></a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Wallapop</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../06_Wallapop/01_exploration.html">Mining in Wallapop 2024 Edition</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/executablebooks/jupyter-book/issues/new?title=Issue%20on%20page%20%2F03_Vinted_Data_Science/01_price_prediction.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/03_Vinted_Data_Science/01_price_prediction.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>01: Price Regression with LightGBM</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction"><a id="toc1_1_"></a><span class="xref myst">Introduction</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#lightgbm-out-of-the-box-approach"><a id="toc1_1_1_"></a><span class="xref myst">LightGBM - out of the box approach</span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#loading-packages-and-data"><a id="toc1_1_2_"></a><span class="xref myst">Loading packages and data</span></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#preprocessing"><a id="toc1_2_"></a><span class="xref myst">Preprocessing</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#taking-a-deeper-look-into-size-title"><a id="toc1_2_3_"></a><span class="xref myst">Taking a deeper look into size title</span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#taking-a-deeper-look-into-brand-title"><a id="toc1_2_4_"></a><span class="xref myst">Taking a deeper look into brand title</span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#approaches-to-size-titles"><a id="toc1_2_5_"></a><span class="xref myst">Approaches to size titles</span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#approaches-to-brand-titles"><a id="toc1_2_6_"></a><span class="xref myst">Approaches to brand titles</span></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lightgbm-regression-model"><a id="toc1_3_"></a><span class="xref myst">LightGBM regression model</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#q-q-plot"><a id="toc1_3_1_"></a><span class="xref myst">Q-Q Plot</span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#kolmogorov-smirnov-test"><a id="toc1_3_2_"></a><span class="xref myst">Kolmogorov-Smirnov Test</span></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#analysis-of-the-results"><a id="toc1_4_"></a><span class="xref myst">Analysis of the results</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#shapley-additive-explanations"><a id="toc1_4_1_"></a><span class="xref myst">SHapley Additive exPlanations</span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusions"><a id="toc1_4_2_"></a><span class="xref myst">Conclusions</span></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#future-work"><a id="toc1_5_"></a><span class="xref myst">Future work</span></a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="price-regression-with-lightgbm">
<h1><a class="reference internal" href="#toc0_"><span class="xref myst">01: Price Regression with LightGBM</span></a><a class="headerlink" href="#price-regression-with-lightgbm" title="Link to this heading">#</a></h1>
<p>This is a dummy example on how to build an algorithm which predicts article prices based on product characteristerics.
The purpose is to employ LightGBM to solve this regression problem and predict prices according the given data labels and to understand the feature contribution of each underlying variable.</p>
<p><strong>Keywords</strong>: LightGBM, regression modelling, price prediction, Vinted</p>
<p><strong>Table of contents</strong><a id='toc0_'></a></p>
<ul class="simple">
<li><p><a class="reference internal" href="#toc1_"><span class="xref myst">01: Price Regression with LightGBM</span></a></p>
<ul>
<li><p><a class="reference internal" href="#toc1_1_"><span class="xref myst">Introduction</span></a></p>
<ul>
<li><p><a class="reference internal" href="#toc1_1_1_"><span class="xref myst">LightGBM - out of the box approach</span></a></p></li>
<li><p><a class="reference internal" href="#toc1_1_2_"><span class="xref myst">Loading packages and data</span></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#toc1_2_"><span class="xref myst">Preprocessing</span></a></p>
<ul>
<li><p><a class="reference internal" href="#toc1_2_3_"><span class="xref myst">Taking a deeper look into size title</span></a></p></li>
<li><p><a class="reference internal" href="#toc1_2_4_"><span class="xref myst">Taking a deeper look into brand title</span></a></p></li>
<li><p><a class="reference internal" href="#toc1_2_5_"><span class="xref myst">Approaches to size titles</span></a></p></li>
<li><p><a class="reference internal" href="#toc1_2_6_"><span class="xref myst">Approaches to brand titles</span></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#toc1_3_"><span class="xref myst">LightGBM regression model</span></a></p>
<ul>
<li><p><a class="reference internal" href="#toc1_3_1_"><span class="xref myst">Q-Q Plot</span></a></p></li>
<li><p><a class="reference internal" href="#toc1_3_2_"><span class="xref myst">Kolmogorov-Smirnov Test</span></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#toc1_4_"><span class="xref myst">Analysis of the results</span></a></p>
<ul>
<li><p><a class="reference internal" href="#toc1_4_1_"><span class="xref myst">SHapley Additive exPlanations</span></a></p></li>
<li><p><a class="reference internal" href="#toc1_4_2_"><span class="xref myst">Conclusions</span></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#toc1_5_"><span class="xref myst">Future work</span></a></p></li>
</ul>
</li>
</ul>
<!-- vscode-jupyter-toc-config
	numbering=false
	anchor=true
	flat=false
	minLevel=1
	maxLevel=6
	/vscode-jupyter-toc-config -->
<!-- THIS CELL WILL BE REPLACED ON TOC UPDATE. DO NOT WRITE YOUR TEXT IN THIS CELL --><section id="introduction">
<h2><a id='toc1_1_'></a><a class="reference internal" href="#toc0_"><span class="xref myst">Introduction</span></a><a class="headerlink" href="#introduction" title="Link to this heading">#</a></h2>
<section id="lightgbm-out-of-the-box-approach">
<h3><a id='toc1_1_1_'></a><a class="reference internal" href="#toc0_"><span class="xref myst">LightGBM - out of the box approach</span></a><a class="headerlink" href="#lightgbm-out-of-the-box-approach" title="Link to this heading">#</a></h3>
<p>LightGBM, short for Light Gradient Boosting Machine, is a powerful and efficient gradient boosting framework developed by Microsoft.
One of the key features of LightGBM is its ability to handle large datasets with millions of samples and features efficiently. It achieves this by using a novel tree-based learning algorithm that grows trees leaf-wise rather than level-wise, which reduces memory usage and speeds up training.</p>
<p>LightGBM supports parallel and distributed computing, enabling it to leverage multicore CPUs and multiple physical infrastructures. The main advantage of LightGBM is its flexibility to run multiple objectives functions and cost functions as well as a wide array of hyperparam which can be tuned to optimize performance and adapt to problems.</p>
</section>
<section id="loading-packages-and-data">
<h3><a id='toc1_1_2_'></a><a class="reference internal" href="#toc0_"><span class="xref myst">Loading packages and data</span></a><a class="headerlink" href="#loading-packages-and-data" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">create_engine</span>
<span class="kn">import</span> <span class="nn">plotly.express</span> <span class="k">as</span> <span class="nn">px</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">mean_squared_error</span>
<span class="kn">import</span> <span class="nn">lightgbm</span> <span class="k">as</span> <span class="nn">lgb</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">import</span> <span class="nn">shap</span>
<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">kstest</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">train_test_split</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">KeyboardInterrupt</span><span class="g g-Whitespace">                         </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">line</span> <span class="mi">10</span>
<span class="g g-Whitespace">      </span><span class="mi">8</span> <span class="kn">import</span> <span class="nn">lightgbm</span> <span class="k">as</span> <span class="nn">lgb</span>
<span class="g g-Whitespace">      </span><span class="mi">9</span> <span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="ne">---&gt; </span><span class="mi">10</span> <span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="g g-Whitespace">     </span><span class="mi">11</span> <span class="kn">import</span> <span class="nn">shap</span>
<span class="g g-Whitespace">     </span><span class="mi">12</span> <span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">kstest</span>

<span class="n">File</span> <span class="o">~</span>\<span class="n">AppData</span>\<span class="n">Local</span>\<span class="n">Programs</span>\<span class="n">Python</span>\<span class="n">Python310</span>\<span class="n">lib</span>\<span class="n">site</span><span class="o">-</span><span class="n">packages</span>\<span class="n">statsmodels</span>\<span class="n">api</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">144</span>
<span class="g g-Whitespace">    </span><span class="mi">142</span> <span class="kn">from</span> <span class="nn">.tools.tools</span> <span class="kn">import</span> <span class="n">add_constant</span><span class="p">,</span> <span class="n">categorical</span>
<span class="g g-Whitespace">    </span><span class="mi">143</span> <span class="kn">from</span> <span class="nn">.tools.web</span> <span class="kn">import</span> <span class="n">webdoc</span>
<span class="ne">--&gt; </span><span class="mi">144</span> <span class="kn">from</span> <span class="nn">.tsa</span> <span class="kn">import</span> <span class="n">api</span> <span class="k">as</span> <span class="n">tsa</span>
<span class="g g-Whitespace">    </span><span class="mi">146</span> <span class="n">load</span> <span class="o">=</span> <span class="n">load_pickle</span>

<span class="n">File</span> <span class="o">~</span>\<span class="n">AppData</span>\<span class="n">Local</span>\<span class="n">Programs</span>\<span class="n">Python</span>\<span class="n">Python310</span>\<span class="n">lib</span>\<span class="n">site</span><span class="o">-</span><span class="n">packages</span>\<span class="n">statsmodels</span>\<span class="n">tsa</span>\<span class="n">api</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">78</span>
<span class="g g-Whitespace">     </span><span class="mi">76</span> <span class="kn">from</span> <span class="nn">.holtwinters</span> <span class="kn">import</span> <span class="n">ExponentialSmoothing</span><span class="p">,</span> <span class="n">Holt</span><span class="p">,</span> <span class="n">SimpleExpSmoothing</span>
<span class="g g-Whitespace">     </span><span class="mi">77</span> <span class="kn">from</span> <span class="nn">.innovations</span> <span class="kn">import</span> <span class="n">api</span> <span class="k">as</span> <span class="n">innovations</span>
<span class="ne">---&gt; </span><span class="mi">78</span> <span class="kn">from</span> <span class="nn">.regime_switching.markov_autoregression</span> <span class="kn">import</span> <span class="n">MarkovAutoregression</span>
<span class="g g-Whitespace">     </span><span class="mi">79</span> <span class="kn">from</span> <span class="nn">.regime_switching.markov_regression</span> <span class="kn">import</span> <span class="n">MarkovRegression</span>
<span class="g g-Whitespace">     </span><span class="mi">80</span> <span class="kn">from</span> <span class="nn">.seasonal</span> <span class="kn">import</span> <span class="n">STL</span><span class="p">,</span> <span class="n">seasonal_decompose</span>

<span class="n">File</span> <span class="o">~</span>\<span class="n">AppData</span>\<span class="n">Local</span>\<span class="n">Programs</span>\<span class="n">Python</span>\<span class="n">Python310</span>\<span class="n">lib</span>\<span class="n">site</span><span class="o">-</span><span class="n">packages</span>\<span class="n">statsmodels</span>\<span class="n">tsa</span>\<span class="n">regime_switching</span>\<span class="n">markov_autoregression</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">13</span>
<span class="g g-Whitespace">     </span><span class="mi">10</span> <span class="kn">import</span> <span class="nn">statsmodels.base.wrapper</span> <span class="k">as</span> <span class="nn">wrap</span>
<span class="g g-Whitespace">     </span><span class="mi">12</span> <span class="kn">from</span> <span class="nn">statsmodels.tsa.tsatools</span> <span class="kn">import</span> <span class="n">lagmat</span>
<span class="ne">---&gt; </span><span class="mi">13</span> <span class="kn">from</span> <span class="nn">statsmodels.tsa.regime_switching</span> <span class="kn">import</span> <span class="p">(</span>
<span class="g g-Whitespace">     </span><span class="mi">14</span>     <span class="n">markov_switching</span><span class="p">,</span> <span class="n">markov_regression</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">15</span> <span class="kn">from</span> <span class="nn">statsmodels.tsa.statespace.tools</span> <span class="kn">import</span> <span class="p">(</span>
<span class="g g-Whitespace">     </span><span class="mi">16</span>     <span class="n">constrain_stationary_univariate</span><span class="p">,</span> <span class="n">unconstrain_stationary_univariate</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">19</span> <span class="k">class</span> <span class="nc">MarkovAutoregression</span><span class="p">(</span><span class="n">markov_regression</span><span class="o">.</span><span class="n">MarkovRegression</span><span class="p">):</span>

<span class="n">File</span> <span class="o">~</span>\<span class="n">AppData</span>\<span class="n">Local</span>\<span class="n">Programs</span>\<span class="n">Python</span>\<span class="n">Python310</span>\<span class="n">lib</span>\<span class="n">site</span><span class="o">-</span><span class="n">packages</span>\<span class="n">statsmodels</span>\<span class="n">tsa</span>\<span class="n">regime_switching</span>\<span class="n">markov_switching</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">21</span>
<span class="g g-Whitespace">     </span><span class="mi">19</span> <span class="kn">from</span> <span class="nn">statsmodels.tools.tools</span> <span class="kn">import</span> <span class="n">Bunch</span><span class="p">,</span> <span class="n">pinv_extended</span>
<span class="g g-Whitespace">     </span><span class="mi">20</span> <span class="kn">import</span> <span class="nn">statsmodels.tsa.base.tsa_model</span> <span class="k">as</span> <span class="nn">tsbase</span>
<span class="ne">---&gt; </span><span class="mi">21</span> <span class="kn">from</span> <span class="nn">statsmodels.tsa.regime_switching._hamilton_filter</span> <span class="kn">import</span> <span class="p">(</span>
<span class="g g-Whitespace">     </span><span class="mi">22</span>     <span class="n">chamilton_filter_log</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">23</span>     <span class="n">dhamilton_filter_log</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">24</span>     <span class="n">shamilton_filter_log</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">25</span>     <span class="n">zhamilton_filter_log</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">26</span> <span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">27</span> <span class="kn">from</span> <span class="nn">statsmodels.tsa.regime_switching._kim_smoother</span> <span class="kn">import</span> <span class="p">(</span>
<span class="g g-Whitespace">     </span><span class="mi">28</span>     <span class="n">ckim_smoother_log</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">29</span>     <span class="n">dkim_smoother_log</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">30</span>     <span class="n">skim_smoother_log</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">31</span>     <span class="n">zkim_smoother_log</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">32</span> <span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">33</span> <span class="kn">from</span> <span class="nn">statsmodels.tsa.statespace.tools</span> <span class="kn">import</span> <span class="p">(</span>
<span class="g g-Whitespace">     </span><span class="mi">34</span>     <span class="n">find_best_blas_type</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">35</span>     <span class="n">prepare_exog</span><span class="p">,</span>
<span class="g g-Whitespace">     </span><span class="mi">36</span>     <span class="n">_safe_cond</span>
<span class="g g-Whitespace">     </span><span class="mi">37</span> <span class="p">)</span>

<span class="nn">File &lt;frozen importlib._bootstrap&gt;:404,</span> in <span class="ni">parent</span><span class="nt">(self)</span>

<span class="ne">KeyboardInterrupt</span>: 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">load_credentials</span><span class="p">(</span><span class="n">path</span> <span class="o">=</span> <span class="s2">&quot;aws_rds_credentials.json&quot;</span><span class="p">):</span>
     <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
          <span class="n">config</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>

     <span class="c1"># set up credentials</span>
     <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
          <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

     <span class="k">return</span>


<span class="n">load_credentials</span><span class="p">()</span>

<span class="n">aws_rds_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;postgresql://</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">@</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;host&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;port&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;database&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">?sslmode=require&quot;</span>

<span class="c1"># Load a sample dataset</span>
<span class="k">def</span> <span class="nf">load_data</span><span class="p">():</span>
    <span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">aws_rds_url</span><span class="p">)</span>
    <span class="n">sql_query</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;SELECT size_title, color1, brand_title, price_numeric, status, catalog_id, package_size_id, country, product_id</span>
<span class="s2">                    FROM public.tracking_staging </span>
<span class="s2">                    LIMIT 500000</span>
<span class="s2">                    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="n">sql_query</span><span class="p">,</span> <span class="n">engine</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">df</span><span class="p">)</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">load_data</span><span class="p">()</span>
<span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>size_title</th>
      <th>color1</th>
      <th>brand_title</th>
      <th>price_numeric</th>
      <th>status</th>
      <th>catalog_id</th>
      <th>package_size_id</th>
      <th>country</th>
      <th>product_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>S / 36 / 8</td>
      <td>Caqui</td>
      <td>Stradivarius</td>
      <td>2</td>
      <td>Novo sem etiquetas</td>
      <td>1041</td>
      <td>1</td>
      <td>España</td>
      <td>4073909016</td>
    </tr>
    <tr>
      <th>1</th>
      <td>S / 36 / 8</td>
      <td>Preto</td>
      <td>Stradivarius</td>
      <td>2</td>
      <td>Novo sem etiquetas</td>
      <td>1041</td>
      <td>1</td>
      <td>España</td>
      <td>4073903241</td>
    </tr>
    <tr>
      <th>2</th>
      <td>S / 36 / 8</td>
      <td>Bege</td>
      <td>Stradivarius</td>
      <td>2</td>
      <td>Novo sem etiquetas</td>
      <td>534</td>
      <td>1</td>
      <td>España</td>
      <td>4073895644</td>
    </tr>
    <tr>
      <th>3</th>
      <td>S / 36 / 8</td>
      <td>Preto</td>
      <td>Pull &amp; Bear</td>
      <td>2</td>
      <td>Novo sem etiquetas</td>
      <td>1041</td>
      <td>1</td>
      <td>España</td>
      <td>4073888604</td>
    </tr>
    <tr>
      <th>4</th>
      <td>S / 36 / 8</td>
      <td>Coral</td>
      <td>Pull &amp; Bear</td>
      <td>5</td>
      <td>Novo sem etiquetas</td>
      <td>1041</td>
      <td>1</td>
      <td>España</td>
      <td>4073862791</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
</section>
<section id="preprocessing">
<h2><a id='toc1_2_'></a><a class="reference internal" href="#toc0_"><span class="xref myst">Preprocessing</span></a><a class="headerlink" href="#preprocessing" title="Link to this heading">#</a></h2>
<p>Because the source table is a staging table, there are a lot of repeated records (only with different dates). We will keep only the last row per product_id.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="s1">&#39;product_id&#39;</span><span class="p">,</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">keep</span><span class="o">=</span> <span class="s2">&quot;last&quot;</span><span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>size_title</th>
      <th>color1</th>
      <th>brand_title</th>
      <th>price_numeric</th>
      <th>status</th>
      <th>catalog_id</th>
      <th>package_size_id</th>
      <th>country</th>
      <th>product_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>56</th>
      <td>L</td>
      <td>None</td>
      <td>Medela</td>
      <td>20</td>
      <td>Novo com etiquetas</td>
      <td>1618</td>
      <td>1</td>
      <td>France</td>
      <td>4070092218</td>
    </tr>
    <tr>
      <th>63</th>
      <td>Tamanho único</td>
      <td>None</td>
      <td>Rubbabu</td>
      <td>7</td>
      <td>Muito bom</td>
      <td>1730</td>
      <td>1</td>
      <td>France</td>
      <td>4021488969</td>
    </tr>
    <tr>
      <th>64</th>
      <td>6 anos / 116 cm</td>
      <td>Preto</td>
      <td>Nike</td>
      <td>45</td>
      <td>Novo com etiquetas</td>
      <td>1204</td>
      <td>1</td>
      <td>France</td>
      <td>4008165202</td>
    </tr>
    <tr>
      <th>65</th>
      <td>Tamanho único</td>
      <td>None</td>
      <td>Liewood</td>
      <td>22</td>
      <td>Novo com etiquetas</td>
      <td>1770</td>
      <td>1</td>
      <td>France</td>
      <td>4001548670</td>
    </tr>
    <tr>
      <th>80</th>
      <td>9-12 meses / 74 cm</td>
      <td>Azul claro</td>
      <td>Kiabi</td>
      <td>15</td>
      <td>Muito bom</td>
      <td>1696</td>
      <td>2</td>
      <td>France</td>
      <td>3659005909</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>There is a huge loss of data when considering unique product_ids. Since the purpose of the pipeline is to track products accross time as well, the same product might have a registry for each day.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>size_title            0
color1             6792
brand_title           0
price_numeric         0
status                0
catalog_id            0
package_size_id       0
country               0
product_id            0
dtype: int64
</pre></div>
</div>
</div>
</div>
<p><strong>Issues so far</strong></p>
<ul class="simple">
<li><p>catalog_id is int64, other predictors are object. Need to convert them to categorical before feeding to LightGBM</p></li>
<li><p>color1_id has missing values (why?)</p>
<ul>
<li><p>after inspecting and being knowledgeable about the data, there are articles which by nature do not have colors (such as books)</p></li>
</ul>
</li>
<li><p>the most popular size_title is “”</p>
<ul>
<li><p>after inspecting I realize this has to do with “sizeless” items such as books as well</p></li>
</ul>
</li>
<li><p>the most popular brand_title is “”</p>
<ul>
<li><p>this means the article doesn’t have a brand. this can have several reasons, not only due to the misc items but also I believe Vinted allowed the user to publish items with empty brands at some point (I haven’t confirmed this)</p></li>
</ul>
</li>
<li><p>size_title has 230 unique values which is a lot, let’s take a look into that later</p>
<ul>
<li><p>why is that?</p></li>
</ul>
</li>
<li><p>brand_title has 4.7k unique values which is also a lot</p>
<ul>
<li><p>why is that?</p></li>
</ul>
</li>
</ul>
<p><strong>Approaches</strong></p>
<ul class="simple">
<li><p>change dtypes</p></li>
<li><p>create a dummy color1_id and assign it to articles missing color1_id (filling with value 0)</p></li>
<li><p>replacing “” size_title with “no_size” for better semantic representation (otherwise users are left to guess what it means)</p></li>
<li><p>replacing “”brand_title with “no_brand” for the same reason</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;size_title&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;size_title&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;no_size&quot;</span><span class="p">)</span>
<span class="n">data</span><span class="p">[</span><span class="s2">&quot;brand_title&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;brand_title&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;no_brand&quot;</span><span class="p">)</span>
<span class="n">data</span><span class="p">[</span><span class="s2">&quot;color1&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;color1&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s2">&quot;no_color&quot;</span><span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">isnull</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>size_title         0
color1             0
brand_title        0
price_numeric      0
status             0
catalog_id         0
package_size_id    0
country            0
product_id         0
dtype: int64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<section id="taking-a-deeper-look-into-size-title">
<h3><a id='toc1_2_3_'></a><a class="reference internal" href="#toc0_"><span class="xref myst">Taking a deeper look into size title</span></a><a class="headerlink" href="#taking-a-deeper-look-into-size-title" title="Link to this heading">#</a></h3>
<p>Size title has unbalanced labels.</p>
<ul class="simple">
<li><p>Sizes can be further divided into product types. For instance, we have:</p>
<ul>
<li><p>M, XL, S, etc which are the standard clothing sizes</p></li>
<li><p>no_size for the products which do not have size labels</p></li>
<li><p>numeric sizes (40, 41) which refers to footwear</p></li>
<li><p>kids sizes (8 anos, 12 anos, etc)</p></li>
<li><p>cup sizes (95D, 80B)</p></li>
<li><p>jewelry (which im assuming 30 mm diameter refers to)</p></li>
<li><p>volume units (40 x 45 cm)</p></li>
<li><p>weight units (9-18kgs)</p></li>
<li><p>jeans sizes (waist measurements W33)</p></li>
</ul>
</li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;size_title&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(),</span> 
             <span class="n">x</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;size_title&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> 
             <span class="n">y</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;size_title&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
             <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="s1">&#39;Size Title&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="s1">&#39;Count&#39;</span><span class="p">},</span>
             <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Count of Size Title&#39;</span><span class="p">)</span>
<span class="n">fig</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
</section>
<section id="taking-a-deeper-look-into-brand-title">
<h3><a id='toc1_2_4_'></a><a class="reference internal" href="#toc0_"><span class="xref myst">Taking a deeper look into brand title</span></a><a class="headerlink" href="#taking-a-deeper-look-into-brand-title" title="Link to this heading">#</a></h3>
<p>Brand titles has too many brands.</p>
<ul class="simple">
<li><p>A lot of the brands aren’t even brands (such as dri-fit, b(?), GYM, MI(?), etc)</p></li>
<li><p>There are brands that mean the same thing (such as local, locale or any other meaning of thrift clothing)</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;brand_title&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(),</span> 
             <span class="n">x</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;brand_title&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> 
             <span class="n">y</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;brand_title&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
             <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="s1">&#39;Brand Title&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="s1">&#39;Count&#39;</span><span class="p">},</span>
             <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Count of Brand Title&#39;</span><span class="p">)</span>
<span class="n">fig</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
</section>
<section id="approaches-to-size-titles">
<h3><a id='toc1_2_5_'></a><a class="reference internal" href="#toc0_"><span class="xref myst">Approaches to size titles</span></a><a class="headerlink" href="#approaches-to-size-titles" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Feature engineering</p>
<ul>
<li><p>We can easily split garments from shoes, if we consider shoes have only numeric values assigned to sizes</p></li>
</ul>
</li>
<li><p>Remove size classes below a certain threshold</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">label_counts</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;size_title&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>

<span class="c1"># Filter the labels with more than 100 occurrences</span>
<span class="n">labels_more_than_100</span> <span class="o">=</span> <span class="n">label_counts</span><span class="p">[</span><span class="n">label_counts</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="c1"># Filter the DataFrame based on the selected labels</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;size_title&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">labels_more_than_100</span><span class="p">)]</span>
<span class="n">data</span><span class="p">[</span><span class="s1">&#39;size_title&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([&#39;L&#39;, &#39;Tamanho único&#39;, &#39;6 anos / 116 cm&#39;, &#39;9-12 meses / 74\xa0cm&#39;,
       &#39;no_size&#39;, &#39;3 anos / 98 cm&#39;, &#39;6-9 meses / 68 cm&#39;,
       &#39;12-18 meses / 80\xa0cm&#39;, &#39;18-24 meses / 86\xa0cm&#39;,
       &#39;3-6 meses / 62\xa0cm&#39;, &#39;45&#39;, &#39;5 anos / 110 cm&#39;, &#39;XS / 34 / 6&#39;,
       &#39;XXXL / 46 / 18&#39;, &#39;XL / 42 / 14&#39;, &#39;XXL / 44 / 16&#39;, &#39;S / 36 / 8&#39;,
       &#39;XL&#39;, &#39;9 anos / 134 cm&#39;, &#39;M&#39;, &#39;11 anos / 146 cm&#39;, &#39;M / 38 / 10&#39;,
       &#39;10 anos / 140 cm&#39;, &#39;S&#39;, &#39;39&#39;, &#39;XS&#39;, &#39;L / 40 / 12&#39;,
       &#39;8 anos / 128 cm&#39;, &#39;16 anos / 176 cm&#39;, &#39;Outro&#39;, &#39;38&#39;, &#39;36&#39;,
       &#39;4 anos / 104 cm&#39;, &#39;1-3 meses / 56\xa0cm&#39;, &#39;Até 1 mês / 50\xa0cm&#39;,
       &#39;44&#39;, &#39;XXL&#39;, &#39;40&#39;, &#39;24-36 meses / 92 cm&#39;, &#39;XXS / 32 / 4&#39;, &#39;41&#39;,
       &#39;43&#39;, &#39;12 anos / 152 cm&#39;, &#39;37&#39;, &#39;42&#39;, &#39;7 anos / 122 cm&#39;,
       &#39;14 anos / 164 cm&#39;, &#39;PT 42 | W32&#39;, &#39;42,5&#39;], dtype=object)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">px</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;brand_title&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(),</span> 
             <span class="n">x</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;brand_title&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> 
             <span class="n">y</span><span class="o">=</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;brand_title&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
             <span class="n">labels</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="s1">&#39;Brand Title&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="s1">&#39;Count&#39;</span><span class="p">},</span>
             <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Count of Brand Title&#39;</span><span class="p">)</span>
<span class="n">fig</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
</div>
</div>
</section>
<section id="approaches-to-brand-titles">
<h3><a id='toc1_2_6_'></a><a class="reference internal" href="#toc0_"><span class="xref myst">Approaches to brand titles</span></a><a class="headerlink" href="#approaches-to-brand-titles" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>Remove size classes below a certain threshold</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">label_counts</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;brand_title&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>

<span class="c1"># Filter the labels with more than 100 occurrences</span>
<span class="n">labels_more_than_100</span> <span class="o">=</span> <span class="n">label_counts</span><span class="p">[</span><span class="n">label_counts</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="c1"># Filter the DataFrame based on the selected labels</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;brand_title&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">labels_more_than_100</span><span class="p">)]</span>
<span class="n">data</span><span class="p">[</span><span class="s1">&#39;brand_title&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([&#39;Nike&#39;, &#39;Kiabi&#39;, &quot;Tape à l&#39;œil&quot;, &#39;no_brand&#39;, &#39;Orchestra&#39;, &#39;Scarpe&#39;,
       &#39;The North Face&#39;, &#39;H&amp;M&#39;, &#39;Zara&#39;, &#39;Mango&#39;, &#39;Decathlon&#39;, &#39;adidas&#39;,
       &#39;Local&#39;, &#39;Timberland&#39;, &#39;Vans&#39;, &#39;Jennyfer&#39;, &quot;Levi&#39;s&quot;, &#39;Shein&#39;,
       &#39;Pull &amp; Bear&#39;, &#39;Primark&#39;, &#39;ONLY&#39;, &#39;Stradivarius&#39;, &#39;Disney&#39;, &#39;Puma&#39;,
       &#39;sans marque&#39;, &#39;Ralph Lauren&#39;, &#39;Lacoste&#39;, &#39;Tommy Hilfiger&#39;,
       &#39;Bershka&#39;, &#39;Donna&#39;, &#39;Cache Cache&#39;, &#39;Pimkie&#39;, &#39;Vintage Dressing&#39;,
       &#39;United Colors of Benetton&#39;, &#39;Camaïeu&#39;, &#39;Gémo&#39;, &#39;Champion&#39;,
       &#39;Inconnu&#39;, &#39;Promod&#39;, &#39;Hollister&#39;, &#39;In Extenso&#39;, &#39;Jordan&#39;,
       &#39;Jack &amp; Jones&#39;, &#39;GUESS&#39;, &#39;Vintage&#39;, &#39;Calvin Klein&#39;], dtype=object)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">label_counts</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;catalog_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>

<span class="c1"># Filter the labels with more than 100 occurrences</span>
<span class="n">labels_more_than_100</span> <span class="o">=</span> <span class="n">label_counts</span><span class="p">[</span><span class="n">label_counts</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="c1"># Filter the DataFrame based on the selected labels</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;catalog_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">labels_more_than_100</span><span class="p">)]</span>
<span class="n">data</span><span class="p">[</span><span class="s2">&quot;catalog_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array([1204, 1662,  198,  222, 1821, 2349, 2632, 1065,  534, 1535, 2333,
       2338, 2346, 2339, 2342, 2344,  221, 1043, 1812, 2336, 2364, 1242,
       1809, 1811, 1807, 1554, 1066, 1803, 2351, 1042,  584,  532,  196,
        224,  194, 1055,  197, 1071, 2337, 2350,  178,   18,  228, 2363,
        223, 1844, 1806,  529, 1801,  164,  163,  267,  156, 2343, 2360,
       1041, 1845], dtype=int64)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># LightGBM also can handle categorical data directly We go to probe its inner method</span>

<span class="c1"># Transform categorical features into the appropriate type that is expected by LightGBM</span>
<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
    <span class="n">col_type</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span>
    <span class="k">if</span> <span class="n">col_type</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span> <span class="ow">or</span> <span class="n">col_type</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;category&#39;</span><span class="p">:</span>
        <span class="n">data</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;category&#39;</span><span class="p">)</span>
<span class="n">data</span><span class="p">[</span><span class="s2">&quot;catalog_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;catalog_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">)</span>
<span class="n">data</span><span class="p">[</span><span class="s2">&quot;package_size_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;package_size_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">X_train</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_test</span> <span class="o">=</span> <span class="n">train_test_split</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;price_numeric&quot;</span><span class="p">]),</span> 
                                                    <span class="n">data</span><span class="p">[</span><span class="s2">&quot;price_numeric&quot;</span><span class="p">],</span> 
                                                    <span class="n">test_size</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> 
                                                    <span class="n">random_state</span><span class="o">=</span><span class="mi">42</span><span class="p">)</span>

<span class="n">X_train</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>size_title</th>
      <th>color1</th>
      <th>brand_title</th>
      <th>status</th>
      <th>catalog_id</th>
      <th>package_size_id</th>
      <th>country</th>
      <th>product_id</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>249074</th>
      <td>Tamanho único</td>
      <td>Preto</td>
      <td>no_brand</td>
      <td>Muito bom</td>
      <td>223</td>
      <td>1</td>
      <td>France</td>
      <td>4283442563</td>
    </tr>
    <tr>
      <th>489912</th>
      <td>M</td>
      <td>Verde-menta</td>
      <td>Levi's</td>
      <td>Muito bom</td>
      <td>1806</td>
      <td>1</td>
      <td>Italie</td>
      <td>4343669455</td>
    </tr>
    <tr>
      <th>488726</th>
      <td>S</td>
      <td>Preto</td>
      <td>Jordan</td>
      <td>Bom</td>
      <td>1807</td>
      <td>1</td>
      <td>Italia</td>
      <td>4093708610</td>
    </tr>
    <tr>
      <th>128678</th>
      <td>no_size</td>
      <td>no_color</td>
      <td>no_brand</td>
      <td>Satisfatório</td>
      <td>2360</td>
      <td>2</td>
      <td>Italia</td>
      <td>4331481169</td>
    </tr>
    <tr>
      <th>377849</th>
      <td>M / 38 / 10</td>
      <td>Preto</td>
      <td>Levi's</td>
      <td>Muito bom</td>
      <td>1845</td>
      <td>1</td>
      <td>France</td>
      <td>4321107822</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
</section>
<section id="lightgbm-regression-model">
<h2><a id='toc1_3_'></a><a class="reference internal" href="#toc0_"><span class="xref myst">LightGBM regression model</span></a><a class="headerlink" href="#lightgbm-regression-model" title="Link to this heading">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d_train</span><span class="o">=</span><span class="n">lgb</span><span class="o">.</span><span class="n">Dataset</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> 
                    <span class="n">label</span><span class="o">=</span><span class="n">y_train</span><span class="p">,</span>
                    <span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;max_bin&quot;</span><span class="p">:</span><span class="mi">128</span><span class="p">})</span>

<span class="c1"># Define parameters for LightGBM</span>
<span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;objective&#39;</span><span class="p">:</span> <span class="s1">&#39;regression&#39;</span><span class="p">,</span>
    <span class="s1">&#39;metric&#39;</span><span class="p">:</span> <span class="s1">&#39;rmse&#39;</span><span class="p">,</span>  <span class="c1"># Root Mean Squared Error    </span>
    <span class="s1">&#39;n_estimators&#39;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
    <span class="s1">&#39;max_depth&#39;</span><span class="p">:</span> <span class="mi">18</span><span class="p">,</span>
    <span class="s1">&#39;num_leaves&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="o">**</span><span class="mi">6</span><span class="p">,</span>
    <span class="s1">&#39;learning_rate&#39;</span><span class="p">:</span> <span class="mf">0.01</span>
<span class="p">}</span>

<span class="n">clf</span><span class="o">=</span><span class="n">lgb</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">params</span><span class="p">,</span>
              <span class="n">d_train</span><span class="p">)</span> 

<span class="c1"># Prediction on the valid set</span>
<span class="n">y_pred</span><span class="o">=</span><span class="n">clf</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>

<span class="c1"># postprocess function</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="n">y_pred</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>
<span class="n">errors</span> <span class="o">=</span> <span class="n">y_pred</span> <span class="o">-</span> <span class="n">y_test</span>

<span class="n">mse</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Mean Squared Error:&quot;</span><span class="p">,</span> <span class="n">mse</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>c:\Users\Miguel\AppData\Local\Programs\Python\Python310\lib\site-packages\lightgbm\engine.py:172: UserWarning:

Found `n_estimators` in params. Will use it instead of argument
</pre></div>
</div>
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[LightGBM] [Info] Auto-choosing col-wise multi-threading, the overhead of testing was 0.000343 seconds.
You can set `force_col_wise=true` to remove the overhead.
[LightGBM] [Info] Total Bins 352
[LightGBM] [Info] Number of data points in the train set: 8708, number of used features: 8
[LightGBM] [Info] Start training from score 12.040423
Mean Squared Error: 288.93755739210286
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">y_test</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>
<span class="n">results</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Prediction&quot;</span><span class="p">,</span> <span class="s2">&quot;Test&quot;</span><span class="p">]</span>
<span class="n">results</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Prediction</th>
      <th>Test</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>3</td>
      <td>2</td>
    </tr>
    <tr>
      <th>1</th>
      <td>15</td>
      <td>28</td>
    </tr>
    <tr>
      <th>2</th>
      <td>9</td>
      <td>6</td>
    </tr>
    <tr>
      <th>3</th>
      <td>3</td>
      <td>5</td>
    </tr>
    <tr>
      <th>4</th>
      <td>4</td>
      <td>3</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># y_pred/y_test plot</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">y_pred</span><span class="p">,</span> <span class="n">y_test</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;blue&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">y_test</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> 
          <span class="n">y_test</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span> 
          <span class="p">[</span><span class="n">y_test</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> 
           <span class="n">y_test</span><span class="o">.</span><span class="n">max</span><span class="p">()],</span> 
           <span class="s1">&#39;k--&#39;</span><span class="p">,</span> 
           <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># Diagonal line</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Actual&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Predicted&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Actual vs. Predicted&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Text(0.5, 1.0, &#39;Actual vs. Predicted&#39;)
</pre></div>
</div>
<img alt="../_images/caf90276c402695e36a496995860a5316e45ab6b759e27252488b0c191cb015e.png" src="../_images/caf90276c402695e36a496995860a5316e45ab6b759e27252488b0c191cb015e.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">errors</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;skyblue&#39;</span><span class="p">,</span> <span class="n">edgecolor</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Residuals&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Frequency&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Distribution of Residuals&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/98da41b1d4f2550d6449c38d0c00b2ea26b7fbf620d5377aef1f6aaea73d0621.png" src="../_images/98da41b1d4f2550d6449c38d0c00b2ea26b7fbf620d5377aef1f6aaea73d0621.png" />
</div>
</div>
<section id="q-q-plot">
<h3><a id='toc1_3_1_'></a><a class="reference internal" href="#toc0_"><span class="xref myst">Q-Q Plot</span></a><a class="headerlink" href="#q-q-plot" title="Link to this heading">#</a></h3>
<p>A visual representation of residue normality. The Q-Q plot shows the data doesn’t come from a normal distribution because it’s tails deviate from the expected quantiles line. This means that the values in our residues are much more extreme than the values we would normally expected from a normal distribution.</p>
<p>This visual method tells us that our residues are within normal distribution range for up to 2 quantiles from the mean, but for extreme values it doesn’t belong to the distribution. We can confirm the hypothesis by doing KS test.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Q-Q plot of residuals</span>
<span class="n">sm</span><span class="o">.</span><span class="n">qqplot</span><span class="p">(</span><span class="n">errors</span><span class="p">,</span> <span class="n">line</span><span class="o">=</span><span class="s1">&#39;s&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Q-Q Plot of Residuals&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/d977b639347b1f15a17bbd4437af4bf0a48e5c8b34f8a3b8e42354b4c1bada9b.png" src="../_images/d977b639347b1f15a17bbd4437af4bf0a48e5c8b34f8a3b8e42354b4c1bada9b.png" />
</div>
</div>
</section>
<section id="kolmogorov-smirnov-test">
<h3><a id='toc1_3_2_'></a><a class="reference internal" href="#toc0_"><span class="xref myst">Kolmogorov-Smirnov Test</span></a><a class="headerlink" href="#kolmogorov-smirnov-test" title="Link to this heading">#</a></h3>
<p>The null hypothesis (<span class="math notranslate nohighlight">\(H_0\)</span>​) of the Kolmogorov-Smirnov test is that the two samples are drawn from the same distribution. The alternative hypothesis (H1H1​) is that the two samples are drawn from different distributions.</p>
<ul class="simple">
<li><p>Null Hypothesis (<span class="math notranslate nohighlight">\(H_0\)</span>​): The cumulative distribution functions of the two samples are equal.</p></li>
<li><p>Alternative Hypothesis (<span class="math notranslate nohighlight">\(H_1\)</span>​): The cumulative distribution functions of the two samples are not equal.</p></li>
</ul>
<p>We are going to use the normal distribution as our reference distribution.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ks_test_stat</span><span class="p">,</span> <span class="n">ks_p_value</span> <span class="o">=</span> <span class="n">kstest</span><span class="p">(</span><span class="n">errors</span><span class="p">,</span> <span class="s1">&#39;norm&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Kolmogorov-Smirnov Test:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Test Statistic:&quot;</span><span class="p">,</span> <span class="n">ks_test_stat</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;p-value:&quot;</span><span class="p">,</span> <span class="n">ks_p_value</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Kolmogorov-Smirnov Test:
Test Statistic: 0.3344576937269451
p-value: 1.0081601321175741e-217
</pre></div>
</div>
</div>
</div>
<p>We reject the null hypothesis that the errors are normaly distributed. (p-value &lt; 0.05 (alfa))</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate error scores for different values in brand_title and catalog_id</span>
<span class="n">error_scores</span> <span class="o">=</span> <span class="p">{}</span>
<span class="c1">#for label in [&#39;brand_title&#39;, &#39;catalog_id&#39;]:</span>
<span class="n">unique_values</span> <span class="o">=</span> <span class="n">X_test</span><span class="p">[</span><span class="s2">&quot;brand_title&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
<span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">unique_values</span><span class="p">:</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">X_test</span><span class="p">[</span><span class="s2">&quot;brand_title&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">value</span>
    <span class="n">error_scores</span><span class="p">[(</span><span class="s2">&quot;brand_title&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)]</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">y_pred</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>

<span class="c1"># Print error scores</span>
<span class="k">for</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">value</span><span class="p">),</span> <span class="n">error_score</span> <span class="ow">in</span> <span class="n">error_scores</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean Squared Error for brand_title &#39;</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">error_score</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Mean Squared Error for brand_title &#39;no_brand&#39;: 56.30853658536585
Mean Squared Error for brand_title &#39;Zara&#39;: 25.053846153846155
Mean Squared Error for brand_title &#39;adidas&#39;: 2723.378048780488
Mean Squared Error for brand_title &#39;Shein&#39;: 7.741935483870968
Mean Squared Error for brand_title &#39;H&amp;M&#39;: 28.118279569892472
Mean Squared Error for brand_title &#39;Local&#39;: 37.625
Mean Squared Error for brand_title &#39;Ralph Lauren&#39;: 149.97826086956522
Mean Squared Error for brand_title &#39;Nike&#39;: 1334.4285714285713
Mean Squared Error for brand_title &#39;The North Face&#39;: 76.625
Mean Squared Error for brand_title &#39;Mango&#39;: 47.94117647058823
Mean Squared Error for brand_title &#39;Kiabi&#39;: 3.7777777777777777
Mean Squared Error for brand_title &#39;Donna&#39;: 6.888888888888889
Mean Squared Error for brand_title &#39;Jennyfer&#39;: 9.45
Mean Squared Error for brand_title &#39;Levi&#39;s&#39;: 49.67857142857143
Mean Squared Error for brand_title &#39;sans marque&#39;: 8.4375
Mean Squared Error for brand_title &#39;Champion&#39;: 170.5
Mean Squared Error for brand_title &#39;Hollister&#39;: 22.692307692307693
Mean Squared Error for brand_title &#39;Jordan&#39;: 8457.272727272728
Mean Squared Error for brand_title &#39;Tommy Hilfiger&#39;: 120.72727272727273
Mean Squared Error for brand_title &#39;GUESS&#39;: 92.8
Mean Squared Error for brand_title &#39;Pull &amp; Bear&#39;: 11.794871794871796
Mean Squared Error for brand_title &#39;Bershka&#39;: 16.5531914893617
Mean Squared Error for brand_title &#39;Tape à l&#39;œil&#39;: 3.0
Mean Squared Error for brand_title &#39;Primark&#39;: 13.1
Mean Squared Error for brand_title &#39;Cache Cache&#39;: 17.42105263157895
Mean Squared Error for brand_title &#39;Timberland&#39;: 96.25
Mean Squared Error for brand_title &#39;Lacoste&#39;: 241.34782608695653
Mean Squared Error for brand_title &#39;Gémo&#39;: 3.6666666666666665
Mean Squared Error for brand_title &#39;ONLY&#39;: 14.80952380952381
Mean Squared Error for brand_title &#39;Disney&#39;: 57.1
Mean Squared Error for brand_title &#39;Camaïeu&#39;: 3.9642857142857144
Mean Squared Error for brand_title &#39;Puma&#39;: 291.17391304347825
Mean Squared Error for brand_title &#39;Stradivarius&#39;: 50.705882352941174
Mean Squared Error for brand_title &#39;Vintage&#39;: 695.7083333333334
Mean Squared Error for brand_title &#39;Vintage Dressing&#39;: 45.57142857142857
Mean Squared Error for brand_title &#39;Vans&#39;: 305.0
Mean Squared Error for brand_title &#39;Jack &amp; Jones&#39;: 31.25
Mean Squared Error for brand_title &#39;Promod&#39;: 13.0
Mean Squared Error for brand_title &#39;Pimkie&#39;: 16.42105263157895
Mean Squared Error for brand_title &#39;Calvin Klein&#39;: 60.875
Mean Squared Error for brand_title &#39;Orchestra&#39;: 3.3333333333333335
Mean Squared Error for brand_title &#39;Decathlon&#39;: 10.2
Mean Squared Error for brand_title &#39;In Extenso&#39;: 37.166666666666664
Mean Squared Error for brand_title &#39;United Colors of Benetton&#39;: 11.0
Mean Squared Error for brand_title &#39;Inconnu&#39;: 244.66666666666666
Mean Squared Error for brand_title &#39;Scarpe&#39;: 49.0
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">error_scores</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">unique_values</span> <span class="o">=</span> <span class="n">X_test</span><span class="p">[</span><span class="s2">&quot;catalog_id&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
<span class="k">for</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">unique_values</span><span class="p">:</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">X_test</span><span class="p">[</span><span class="s2">&quot;catalog_id&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="n">value</span>
    <span class="n">error_scores</span><span class="p">[(</span><span class="s2">&quot;catalog_id&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">)]</span> <span class="o">=</span> <span class="n">mean_squared_error</span><span class="p">(</span><span class="n">y_test</span><span class="p">[</span><span class="n">mask</span><span class="p">],</span> <span class="n">y_pred</span><span class="p">[</span><span class="n">mask</span><span class="p">])</span>

<span class="k">for</span> <span class="p">(</span><span class="n">label</span><span class="p">,</span> <span class="n">value</span><span class="p">),</span> <span class="n">error_score</span> <span class="ow">in</span> <span class="n">error_scores</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Mean Squared Error for catalog_id &#39;</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">error_score</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Mean Squared Error for catalog_id &#39;534&#39;: 7.555555555555555
Mean Squared Error for catalog_id &#39;1065&#39;: 18.948275862068964
Mean Squared Error for catalog_id &#39;1204&#39;: 188.6153846153846
Mean Squared Error for catalog_id &#39;2364&#39;: 6.706521739130435
Mean Squared Error for catalog_id &#39;222&#39;: 62.39393939393939
Mean Squared Error for catalog_id &#39;228&#39;: 10.458333333333334
Mean Squared Error for catalog_id &#39;1043&#39;: 7.7407407407407405
Mean Squared Error for catalog_id &#39;1042&#39;: 3.526315789473684
Mean Squared Error for catalog_id &#39;2349&#39;: 138.93548387096774
Mean Squared Error for catalog_id &#39;163&#39;: 4.066666666666666
Mean Squared Error for catalog_id &#39;1806&#39;: 18.272727272727273
Mean Squared Error for catalog_id &#39;2337&#39;: 112.06060606060606
Mean Squared Error for catalog_id &#39;1821&#39;: 141.72222222222223
Mean Squared Error for catalog_id &#39;1242&#39;: 5884.962962962963
Mean Squared Error for catalog_id &#39;196&#39;: 33.86538461538461
Mean Squared Error for catalog_id &#39;267&#39;: 136.55555555555554
Mean Squared Error for catalog_id &#39;1803&#39;: 14.55
Mean Squared Error for catalog_id &#39;2336&#39;: 143.44117647058823
Mean Squared Error for catalog_id &#39;2344&#39;: 84.06896551724138
Mean Squared Error for catalog_id &#39;1844&#39;: 10.891891891891891
Mean Squared Error for catalog_id &#39;1066&#39;: 18.772727272727273
Mean Squared Error for catalog_id &#39;1809&#39;: 39.67796610169491
Mean Squared Error for catalog_id &#39;1535&#39;: 3.1785714285714284
Mean Squared Error for catalog_id &#39;1801&#39;: 53.523809523809526
Mean Squared Error for catalog_id &#39;221&#39;: 20.3984375
Mean Squared Error for catalog_id &#39;164&#39;: 10.266666666666667
Mean Squared Error for catalog_id &#39;194&#39;: 78.0909090909091
Mean Squared Error for catalog_id &#39;197&#39;: 81.71428571428571
Mean Squared Error for catalog_id &#39;2360&#39;: 230.0952380952381
Mean Squared Error for catalog_id &#39;1811&#39;: 43.55
Mean Squared Error for catalog_id &#39;1662&#39;: 4.4411764705882355
Mean Squared Error for catalog_id &#39;2346&#39;: 52.666666666666664
Mean Squared Error for catalog_id &#39;198&#39;: 335.6875
Mean Squared Error for catalog_id &#39;2343&#39;: 53.26470588235294
Mean Squared Error for catalog_id &#39;178&#39;: 17.76923076923077
Mean Squared Error for catalog_id &#39;1041&#39;: 6.846153846153846
Mean Squared Error for catalog_id &#39;1807&#39;: 116.95121951219512
Mean Squared Error for catalog_id &#39;532&#39;: 43.903225806451616
Mean Squared Error for catalog_id &#39;584&#39;: 699.3170731707318
Mean Squared Error for catalog_id &#39;2339&#39;: 11.653846153846153
Mean Squared Error for catalog_id &#39;2363&#39;: 16.42105263157895
Mean Squared Error for catalog_id &#39;1071&#39;: 74.38461538461539
Mean Squared Error for catalog_id &#39;2342&#39;: 12.829268292682928
Mean Squared Error for catalog_id &#39;2338&#39;: 24.07547169811321
Mean Squared Error for catalog_id &#39;156&#39;: 19.384615384615383
Mean Squared Error for catalog_id &#39;223&#39;: 7.44
Mean Squared Error for catalog_id &#39;18&#39;: 19.59090909090909
Mean Squared Error for catalog_id &#39;2351&#39;: 238.2258064516129
Mean Squared Error for catalog_id &#39;2632&#39;: 297.1842105263158
Mean Squared Error for catalog_id &#39;1845&#39;: 101.66666666666667
Mean Squared Error for catalog_id &#39;224&#39;: 8.058823529411764
Mean Squared Error for catalog_id &#39;1554&#39;: 9.696969696969697
Mean Squared Error for catalog_id &#39;1055&#39;: 32.31578947368421
Mean Squared Error for catalog_id &#39;2333&#39;: 78.625
Mean Squared Error for catalog_id &#39;2350&#39;: 68.2
Mean Squared Error for catalog_id &#39;1812&#39;: 293.39130434782606
Mean Squared Error for catalog_id &#39;529&#39;: 11.26923076923077
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="analysis-of-the-results">
<h2><a id='toc1_4_'></a><a class="reference internal" href="#toc0_"><span class="xref myst">Analysis of the results</span></a><a class="headerlink" href="#analysis-of-the-results" title="Link to this heading">#</a></h2>
<section id="shapley-additive-explanations">
<h3><a id='toc1_4_1_'></a><a class="reference internal" href="#toc0_"><span class="xref myst">SHapley Additive exPlanations</span></a><a class="headerlink" href="#shapley-additive-explanations" title="Link to this heading">#</a></h3>
<p>SHAP or SHapley Additive exPlanations is a model agnostic framework which provides interpretability into individual models and feature importance. In short, SHAP accounts for the marginal contribution of each feature to the prediction scores.</p>
<p>We use TreeExplainer because it is used for explaining predictions from tree based models such as LightGBM.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">explainer</span> <span class="o">=</span> <span class="n">shap</span><span class="o">.</span><span class="n">TreeExplainer</span><span class="p">(</span><span class="n">clf</span><span class="p">)</span>
<span class="n">shap_values</span> <span class="o">=</span> <span class="n">explainer</span><span class="o">.</span><span class="n">shap_values</span><span class="p">(</span><span class="n">X_test</span><span class="p">)</span>
<span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">shap_values</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span> <span class="n">X_test</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">shap</span><span class="o">.</span><span class="n">summary_plot</span><span class="p">(</span><span class="n">shap_values</span><span class="p">,</span> 
                  <span class="n">X_test</span><span class="p">,</span> 
                  <span class="n">feature_names</span><span class="o">=</span><span class="n">X_test</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
                  <span class="n">plot_type</span> <span class="o">=</span> <span class="s2">&quot;bar&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/aa8f125025667d70d555c9f8789ea9e0561f6993f1ec16c55b0aff8ad0f6f474.png" src="../_images/aa8f125025667d70d555c9f8789ea9e0561f6993f1ec16c55b0aff8ad0f6f474.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">shap</span><span class="o">.</span><span class="n">dependence_plot</span><span class="p">(</span><span class="s2">&quot;size_title&quot;</span><span class="p">,</span> <span class="n">shap_values</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">interaction_index</span><span class="o">=</span><span class="s2">&quot;catalog_id&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/3094a6f40e7478eac65196630331037370629531e09551c420a3b4fe381b8bb4.png" src="../_images/3094a6f40e7478eac65196630331037370629531e09551c420a3b4fe381b8bb4.png" />
</div>
</div>
</section>
<section id="conclusions">
<h3><a id='toc1_4_2_'></a><a class="reference internal" href="#toc0_"><span class="xref myst">Conclusions</span></a><a class="headerlink" href="#conclusions" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>We developed a model with around 200-300 RMSE</p></li>
<li><p>Our model doesn’t yield robust results, as they vary a lot between runs</p></li>
<li><p>As expected, one of the best predictors to price is brand title followed by the product catalog.</p></li>
<li><p>The SHAP values per size_title with biggest value are linked to shoe sizes</p></li>
<li><p>The SHAP values per size_title with biggest negative value are linked to women sizes</p></li>
<li><p>In order to optimize revenue brand_title and catalogs are by far the best predictors of future revenue</p></li>
</ul>
<p>Note: It’s really tough to say which size title predicts higher price because there are a lot of confounding variables (namely product catalogs).</p>
</section>
</section>
<section id="future-work">
<h2><a id='toc1_5_'></a><a class="reference internal" href="#toc0_"><span class="xref myst">Future work</span></a><a class="headerlink" href="#future-work" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>Preprocess the country labels into unique labels (France = Francia)</p></li>
<li><p>Add cross validation to get more robust results</p></li>
<li><p>Add hyperparam tuning</p></li>
<li><p>Add stratified sampling and minimum size per labels in the SQL queries</p></li>
<li><p>Do a small preprocessing step per each catalog</p></li>
</ul>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./03_Vinted_Data_Science"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../01_Vinted_Data_Engineering/02_pipeline_design.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">03: Pipeline Design</p>
      </div>
    </a>
    <a class="right-next"
       href="02_catalog_clustering.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title"><span class="xref myst">02: Clustering of product catalogs with Agglomerative Clustering and t-SNE</span></p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction"><a id="toc1_1_"></a><span class="xref myst">Introduction</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#lightgbm-out-of-the-box-approach"><a id="toc1_1_1_"></a><span class="xref myst">LightGBM - out of the box approach</span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#loading-packages-and-data"><a id="toc1_1_2_"></a><span class="xref myst">Loading packages and data</span></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#preprocessing"><a id="toc1_2_"></a><span class="xref myst">Preprocessing</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#taking-a-deeper-look-into-size-title"><a id="toc1_2_3_"></a><span class="xref myst">Taking a deeper look into size title</span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#taking-a-deeper-look-into-brand-title"><a id="toc1_2_4_"></a><span class="xref myst">Taking a deeper look into brand title</span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#approaches-to-size-titles"><a id="toc1_2_5_"></a><span class="xref myst">Approaches to size titles</span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#approaches-to-brand-titles"><a id="toc1_2_6_"></a><span class="xref myst">Approaches to brand titles</span></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lightgbm-regression-model"><a id="toc1_3_"></a><span class="xref myst">LightGBM regression model</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#q-q-plot"><a id="toc1_3_1_"></a><span class="xref myst">Q-Q Plot</span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#kolmogorov-smirnov-test"><a id="toc1_3_2_"></a><span class="xref myst">Kolmogorov-Smirnov Test</span></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#analysis-of-the-results"><a id="toc1_4_"></a><span class="xref myst">Analysis of the results</span></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#shapley-additive-explanations"><a id="toc1_4_1_"></a><span class="xref myst">SHapley Additive exPlanations</span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#conclusions"><a id="toc1_4_2_"></a><span class="xref myst">Conclusions</span></a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#future-work"><a id="toc1_5_"></a><span class="xref myst">Future work</span></a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Miguel Silva
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>